/*! XMAdmin2016 v0.0.1 | (c) 2015 Jerry */
define("modules/verify-tel",["jQuery","log","validator"],function(t,e,n){"use strict";var i=t("jQuery"),r=t("log"),a=r.log,o=r.error,s=r.warn;if("undefined"==typeof i||"undefined"==typeof i.fn||"string"!=typeof i.fn.jquery)return void o("Can not find jQuery.");r.$(),a("Module VerifyTel is loading...");var l=t("validator")(),f={target:"#telphone",username:"#username",totalTime:60,type:"normal",url:ROOT_URL+"/sendvcode.html"},u={1:null,2:"该手机已被注册",3:"系统错误",4:"用户不存在",5:"手机与用户不符",13:"该手机已被注册"},d=function(t,e){return a("VerifyTel is initializing..."),this.version="0.1.0",this.selector=t||".verifytel-box","string"!=typeof this.selector?this:(this.container=i(this.selector).first(),0===this.container.length?this:(this.input=this.container.find("input"),this.btn=this.container.find("button"),this.btn.prop("disabled",!1),this.setConfig(e),this._init(),a("VerifyTel is initialized."),this))};d.prototype={_init:function(){var t=this;return t.btn.removeProp("disabled"),t.btn.click(function(){t.sendCode()}),t},setConfig:function(t){var e=this;({telphone:e.container.data("target"),username:e.container.data("username")});return this.params=i.extend(!0,{},f,t),this.params.done=this.params.done||function(t){var n=e.params.totalTime,i=window.setInterval(function(){var t=n+"秒后可重发";e.btn.text(t),0>n&&(window.clearInterval(i),e.btn.text("重新发送"),e.btn.prop("disabled",!1)),--n},1e3)},this.params.error=this.params.error||function(t,n){e._alert(t[n])},e},_getNoticeContainer:function(t){return t.find(".tip").length>0?t.find(".tip").first():t.find("~.tip").length>0?t.find("~.tip").first():i()},notice:function(t,e){var n=this._getNoticeContainer(e);n.length>0?n.text(t):s(e,"has no notice container.")},_alert:function(t){var e=this._getNoticeContainer(this.container);return e.length>0?e.text(t):(alert(t),s("Can not find notice container.","at input.verifytel-box")),this},sendCode:function(){this.ajaxReq&&this.ajaxReq.abort();var t=this,e=i(t.params.telphone);if(0===e.length)return s("Can not find telphone input."),!1;var n=i.trim(e.val()),r=l.telphone(n,l,e);if(!r.status)return t.notice(r.msg,e),!1;var a={phone:n};if("forget"===t.params.type){a.forgetname=i(t.params.username).val().trim(),a.cto="xxoo";var o=l.username(a.forgetname);if(!o.status)return t._alert(o.msg),!1}this.ajaxReq=i.ajax({url:t.params.url+"?t="+Math.random(),data:a,dataType:"json",success:function(e){var n=e;1===n?(t.btn.prop("disabled",!0),t.params.done(e)):t.params.error(u,e)},error:function(){alert("短信发送失败，可能是网络原因")}})}},n.exports=d,a("Module VerifyTel is loaded.")});